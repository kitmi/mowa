'use strict';const mysql=require('mysql2/promise'),Mowa=require('mowa'),Util=Mowa.Util,Promise=Util.Promise,DbService=require('mowa/dist/oolong/runtime/dbservice'),poolByConn={};let MysqlService=class MysqlService extends DbService{constructor(appModule,name,options){super(appModule,'mysql',name,options)}async getConnection(){let pool=poolByConn[this.connectionString];if(!pool){pool=poolByConn[this.connectionString]=mysql.createPool(this.connectionString);this.appModule.serverModule.on('stopping',()=>{pool.end()})}return pool.getConnection()}closeConnection(conn){return conn.release()}getViewSPName(viewName){return'sp_get_'+viewName}};module.exports={type:Mowa.Feature.DBMS,load_:function(appModule,dbs){Util._.forOwn(dbs,(opt,db)=>{if(!opt.connection){throw new Mowa.Error.InvalidConfiguration('Missing connection string.',appModule,`mysql.${db}.connection`)}let service=new MysqlService(appModule,db,opt);appModule.registerService(service.serviceId,service)});return Promise.resolve()}};