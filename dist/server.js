'use strict';const path=require('path'),Util=require('./util.js'),_=Util._,Promise=Util.Promise,AppModule=require('./appmodule.js'),pkg=require('../package.json'),Literal=require('./enum/literal.js');process.on('uncaughtException',e=>{if(!process.env.NODE_ENV||'development'===process.env.NODE_ENV){console.error('UncaughtException: '+e.stack)}else{console.error('UncaughtException: '+e.message||e.toString())}process.exit(1)});let MowaServer=class MowaServer extends AppModule{constructor(name,options){if('undefined'===typeof options){if('undefined'===typeof name){name='server'}else if(_.isPlainObject(name)){options=name;name='server'}}if(options&&options.oneAppMode&&!options.etcPath){options.etcPath=path.resolve(__dirname,'..','conf','oneAppMode')}super(null,name,null,options);this.env=MowaServer.env;this._httpServers=[];this._pendingHttpServer=0}start_(extraFeatures){this.emit('starting',this);this.log('info',`Starting mowa server v.${pkg.version} ...`);let cwd=process.cwd();if(this.absolutePath!==cwd){this._cwdBackup=cwd;process.chdir(this.absolutePath)}this.loadMiddlewareFiles(path.resolve(__dirname,Literal.MIDDLEWARES_PATH));return super.start_(extraFeatures).then(()=>{if(0<this._pendingHttpServer){this.once('allHttpReady',()=>{this.emit('started',this)})}else{this.emit('started',this)}return this}).catch(error=>{if('development'===this.env&&_.isError(error)){console.error(error.stack)}this.log('error','Failed to start server!');process.exit(1)})}stop_(){this.emit('stopping',this);return super.stop_().then(()=>{let promises=this._httpServers.reverse().map(s=>new Promise((resolve,reject)=>{let port=s.address().port;s.close(err=>{if(err)return reject(err);this.log('info',`The http server listening on port [${port}] is stopped.`);resolve()})}));return Promise.all(promises).then(()=>{if(this._cwdBackup){process.chdir(this._cwdBackup)}this._httpServers=[];this.emit('stopped',this)})})}addHttpServer(appModule,httpServer){this._httpServers.push(httpServer);this._pendingHttpServer++;appModule.once('httpReady',()=>{this._pendingHttpServer--;if(0==this._pendingHttpServer){this.emit('allHttpReady')}})}};MowaServer.env=process.env.NODE_ENV||'development';MowaServer.AppModule=AppModule;MowaServer.Util=Util;MowaServer.Error=require('./error.js');MowaServer.HttpCode=require('./enum/httpcode.js');MowaServer.Pattern=require('./enum/pattern.js');MowaServer.Feature=require('./enum/feature.js');MowaServer.Literal=Literal;module.exports=MowaServer;