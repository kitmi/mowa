'use strict';const Mowa=require('../server.js');const Util=Mowa.Util;const Promise=Util.Promise;const _=Util._;const I18n=require('../i18n.js');const DEFAULT_LOCALE='en_AU';const DEFAULT_PRECEDENCE=['query','cookie','header'];class I18nStorage{static get file(){return I18n.File}}class I18nService{constructor(Handler,options){this.HandlerClass=Handler;this.options=options;this.cache=Util.createLRUCache(5)}getI18n(locale){const self=this;let i18nHandler=locale&&this.cache.get(locale);if(!i18nHandler){i18nHandler=new this.HandlerClass(this.options);if(!locale||!i18nHandler.isLocaleSupported(locale)){locale=i18nHandler.defaultLocale;let defaultHandler=this.cache.get(locale);if(defaultHandler){return Promise.resolve(defaultHandler)}}return i18nHandler.setupAsync(locale).then(()=>{self.cache.set(locale,i18nHandler);return Promise.resolve(i18nHandler)})}return Promise.resolve(i18nHandler)}}module.exports={type:Mowa.Feature.SERVICE,load_:function(appModule,config){if(!config.store){throw new Mowa.Error.InvalidConfiguration('Missing store type.',appModule,'i18n.store')}let Storage=I18nStorage[config.store];if(!Storage){throw new Mowa.Error.InvalidConfiguration('Unsupported store type.',appModule,'i18n.store')}let options;if(config.store==='file'){options=Object.assign({},{directory:Mowa.Literal.LOCALE_PATH},config.options)}let service=new I18nService(Storage,options);let precedence=_.isEmpty(config.precedence)?['query','cookie','header']:config.precedence;let queryKey=config.queryKey||'locale';let cookieKey=config.cookieKey||'locale';precedence.forEach(p=>{if(DEFAULT_PRECEDENCE.indexOf(p)===-1){throw new Mowa.Error.InvalidConfiguration('Unknown locale id source: '+source,appModule,'i18n.precedence')}});let i18nMiddleware=async(ctx,next)=>{let locale;let found=precedence.some(source=>{switch(source){case'query':locale=ctx.query[queryKey];break;case'cookie':locale=ctx.cookies.get(cookieKey);break;case'header':let accept=ctx.acceptsLanguages()||'',reg=/(^|,\s*)([a-z-]+)/gi,match,l;while(match=reg.exec(accept)){if(!l){l=match[2]}}locale=l;break;}return!_.isEmpty(locale)});if(found)ctx.requestedLocale=locale;ctx.__=await service.getI18n(ctx.requestedLocale||DEFAULT_LOCALE);await next()};appModule.registerService('i18n',service);appModule.router.use(i18nMiddleware);return Promise.resolve()}};