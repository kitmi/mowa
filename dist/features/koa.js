'use strict';const Mowa=require('../server.js'),Util=Mowa.Util,_=Util._,Promise=Util.Promise;module.exports={type:Mowa.Feature.ENGINE,load_:function(appModule,options){let app=appModule.router;app.env=appModule.serverModule.env;app.proxy=Util.S(options.trustProxy).toBoolean();if('subdomainOffset'in options&&2!==options.subdomainOffset){if(2>options.subdomainOffset){throw new Mowa.Error.InvalidConfiguration('Invalid subdomainOffset. Should be larger or equal to 2.',appModule,'koa.subdomainOffset')}app.subdomainOffset=options.subdomainOffset}if(options.keys){if(!_.isArray(options.keys)){app.keys=[options.keys]}else{app.keys=options.keys}}app.on('error',(err,ctx)=>{if(err.status&&500>err.status){appModule.log('warn',`[${err.status}] `+err.message,ctx&&_.pick(ctx,['method','url','ip']))}else{appModule.log('error',err.message,err.stack)}});let port=options.httpPort||2331;if(!appModule.serverModule.options.deaf){appModule.httpServer=require('http').createServer(app.callback());appModule.serverModule.addHttpServer(appModule,appModule.httpServer);appModule.on('after:'+Mowa.Feature.ROUTING,()=>{appModule.httpServer.listen(port,function(err){if(err)throw err;appModule.log('info',`A http service is listening on port [${this.address().port}] ...`);appModule.emit('httpReady')})})}return Promise.resolve()}};