'use strict';const Util=require('../../util.js'),_=Util._,OolUtils=require('./ool-utils.js');let OolongSchema=class OolongSchema{constructor(linker,oolModule){this.linker=linker;this.name=oolModule.name;this.oolModule=oolModule;this.info=oolModule.schema;this.entities={};this.relations=[];this.views={};this.documents={};this.initialized=false}clone(stack){if(!stack)stack=new Map;let cl=new OolongSchema(this.linker,this.oolModule);stack.set(this,cl);cl.entities=OolUtils.deepClone(this.entities,stack);cl.relations=OolUtils.deepClone(this.relations,stack);cl.views=OolUtils.deepClone(this.views,stack);cl.documents=OolUtils.deepClone(this.documents,stack);cl.initialized=this.initialized;return cl}link(){if(this.initialized){return this}this.linker.log('debug','Initializing schema ['+this.name+'] ...');if(!_.isEmpty(this.info.entities)){this.info.entities.forEach(entityEntry=>{let entity=this.linker.loadEntity(this.oolModule,entityEntry);this.addEntity(entity)})}if(!_.isEmpty(this.info.views)){this.info.views.forEach(viewName=>{this.views[viewName]=this.linker.loadView(this.oolModule,viewName)})}this.initialized=true;return this}addRelation(relation){if(!this.hasEntity(relation.left.name)){this.addEntity(relation.left)}if(!this.hasEntity(relation.right.name)){this.addEntity(relation.right)}let r=Object.assign({},relation,{left:relation.left.name,right:relation.right.name});this.relations.push(r);return this}hasEntity(entityName){return entityName in this.entities}addEntity(entity){if(this.hasEntity(entity.name)){throw new Error(`Entity name [${entity.name}] conflicts in schema [${this.name}].`)}this.entities[entity.name]=entity;return this}getDocumentHierachy(fromModule,docName){if(docName in this.documents){return this.documents[docName]}let doc=this.linker.loadDoc(fromModule,docName);return this.documents[docName]=doc.buildHierarchy(this)}toJSON(){return{name:this.name,entities:_.reduce(this.entities,(r,v,k)=>(r[k]=v.toJSON(),r),{}),views:_.reduce(this.views,(r,v,k)=>(r[k]=v.toJSON(),r),{}),relations:this.relations,documents:this.documents}}};module.exports=OolongSchema;