'use strict';const EventEmitter=require('events'),path=require('path'),Util=require('../../util.js'),_=Util._,OolUtils=require('./ool-utils.js'),Field=require('./field.js');let OolongEntity=class OolongEntity{constructor(linker,name,oolModule,info){this._events=new EventEmitter;this.linker=linker;this.name=name;this.oolModule=oolModule;this.info=info;this.fields={};this.comment=undefined;this.features=undefined;this.key=undefined;this.indexes=undefined;this.isRelationshipEntity=false;this.interfaces=undefined;this.initialized=false}on(eventName,listener){return this._events.on(eventName,listener)}clone(stack){if(!stack)stack=new Map;let cl=new OolongEntity(this.linker,this.name,this.oolModule,this.info);stack.set(this,cl);OolUtils.deepCloneField(this,cl,'comment',stack);OolUtils.deepCloneField(this,cl,'fields',stack);OolUtils.deepCloneField(this,cl,'features',stack);OolUtils.deepCloneField(this,cl,'key',stack);OolUtils.deepCloneField(this,cl,'indexes',stack);OolUtils.deepCloneField(this,cl,'interfaces',stack);cl.isRelationshipEntity=this.isRelationshipEntity;cl.initialized=this.initialized;return cl}link(){if(this.initialized){return this}this.linker.log('debug','Initializing entity ['+this.name+'] ...');if(this.info.base){let baseEntity=this.linker.loadEntity(this.oolModule,this.info.base);this._inherit(baseEntity)}if(this.info.comment){this.comment=this.info.comment}if(this.info.features){this.info.features.forEach(feature=>{let featureName=feature.name,fn=require(path.resolve(__dirname,`./features/${featureName}.js`));fn(this,feature.options)})}this._events.emit('beforeFields');if(this.info.fields){_.each(this.info.fields,(fieldInfo,fieldName)=>{this.addField(fieldName,fieldInfo)})}this._events.emit('afterFields');if(this.info.indexes){_.each(this.info.indexes,index=>{this.addIndex(index)})}if(this.info.key){this.key=this.info.key;if(!this.hasField(this.key)){throw new Error(`Key field "${this.key}" not exist in entity "${this.name}".`)}}if(this.info.interface){this.interfaces=_.cloneDeep(this.info.interface);_.forOwn(this.interfaces,intf=>{if(!_.isEmpty(intf.accept)){intf.accept=_.map(intf.accept,param=>{return _.omit(Object.assign({},this.linker.trackBackType(this.oolModule,param)),['subClass'])})}})}this.initialized=true;return this}markAsRelationshipEntity(){this.isRelationshipEntity=true;return this}hasIndexOn(fields){fields=fields.concat();fields.sort();return-1!=_.findIndex(this.indexes,index=>{return-1===_.findIndex(index.fields,(f,idx)=>fields.length<=idx||fields[idx]!==f)})}addIndex(index){if(!this.indexes){this.indexes=[]}index=OolUtils.deepClone(index);if(index.fields){if(!_.isArray(index.fields)){index.fields=[index.fields]}let fields=index.fields;index.fields=_.map(fields,field=>{let normalizedField=_.camelCase(field);if(!this.hasField(normalizedField)){throw new Error(`Index references non-exist field: ${field}, entity: ${this.name}.`)}return normalizedField});index.fields.sort();if(this.hasIndexOn(index.fields)){throw new Error(`Index on [${index.fields.join(', ')}] already exist in entity [${this.name}].`)}this.indexes.push(index)}else{console.log(index);throw new Error('error')}return this}getEntityAttribute(fieldId){if('$'===fieldId[0]){let token=fieldId.substr(1);switch(token){case'key':return this.fields[this.key];case'feature':return this.features;default:throw new Error(`Filed accessor "${token}" not supported!`);}}else{if(!this.hasField(fieldId)){throw new Error(`Field "${fieldId}" not exists in entity "${this.name}".`)}return this.fields[fieldId]}}hasField(name){return name in this.fields}addField(name,rawInfo){name=_.camelCase(name);if(this.hasField(name)){throw new Error(`Field name [${name}] conflicts in entity [${this.name}].`)}if(rawInfo.type){let fullRawInfo=this.linker.trackBackType(this.oolModule,rawInfo);this.fields[name]=new Field(name,fullRawInfo);if(!this.key){this.key=name}}else{if(!rawInfo.belongTo&&!rawInfo.bindTo){throw new Error(`Invalid field info of [${name}].`)}if(!this.oolModule.relation){this.oolModule.relation=[]}let relationship,right;if(rawInfo.belongTo){relationship='n:1';right=rawInfo.belongTo}else{relationship='1:1';right=rawInfo.bindTo}let relation={left:this.name,leftField:name,right,relationship};if(rawInfo.optional){relation.optional=true}this.oolModule.relation.push(relation)}return this}addFeature(name,feature,allowMultiple){if(!this.features){this.features={}}if(allowMultiple){if(!this.features[name]){this.features[name]=[]}this.features[name].push(feature)}else{if(feature.name in this.features){throw new Error(`Duplicate feature found: ${name}. Turn on allowMultiple to enable multiple occurrence of a feature.`)}this.features[name]=feature}return this}setKey(name){this.key=name;return this}getKeyField(){return this.fields[this.key]}toJSON(){return{name:this.name,comment:this.comment,fields:_.reduce(this.fields,(r,v,k)=>(r[k]=v.toJSON(),r),{}),features:this.features,key:this.key,indexes:this.indexes,isRelationshipEntity:this.isRelationshipEntity}}_inherit(baseEntity){if(!baseEntity.initialized){throw new Error('Extend from an uninitialized entity!')}let stack=new Map;this.fields=OolUtils.deepClone(baseEntity.fields,stack);if(baseEntity.features){this.features=OolUtils.deepClone(baseEntity.features,stack)}if(baseEntity.key){this.key=OolUtils.deepClone(baseEntity.key,stack)}if(baseEntity.indexes){this.indexes=OolUtils.deepClone(baseEntity.indexes,stack)}}};module.exports=OolongEntity;